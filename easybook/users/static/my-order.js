/*! 2015 Baidu Inc. All Rights Reserved */
define("my-doctor/my-order",["require","common/js/ajax","common/js/pagination"],function(require){return{href:function(){var e=$(".footer").data("href");return e}(),api:function(){var e=$(".footer").data("api");return e}(),src:function(){var e=$(".footer").data("src");return e}(),evaluationData:function(e,t){var i=this,n=10,a=require("common/js/ajax"),r=require("common/js/pagination");a({url:""+this.api+"/pc/appointment/list",type:"GET",datatype:"json",data:{status:t,page:e,pageSize:n,zt:i.zt,zt_ext:i.zt_ext},success:function(n){if(0==n.status){n=n.data;var a,o=n.data;if(1==t)a=$(".hidden-txt"),o=n.data;else if(2==t)a=$(".hidden-txt"),o=n.data;if(n.total>0)$(".empty").hide(),i.views(o,t,n.total),new r({total:n.total,pageSize:10,curPage:e,pagerContainer:$(".pagers"),callback:function(e){i.evaluationData(e,t,n.total)}}).init();else $(".empty").show()}},error:function(){}})},views:function(e,t,i){var n=this;i=0|i;for(var a,r=e,o=r.length,s=[],l=0;o>l;l++){if(s.push("<li>"),s.push('<div class="card-title">'),s.push('<p>订单号：<span><a class="appointment-id" href="'+r[l].detailUrl+'">'+r[l].reserveId+"</a></span></p>"),s.push("<p>患者姓名：<span>"+r[l].patientName+"</span></p>"),s.push('<p>订单状态：<span class="appointment-status">'+r[l].auditStatusText+"</span></p>"),s.push("</div>"),s.push('<div class="card-info">'),a=r[l].doctorInfo,a.length>1)s.push('<ul class="card-list">');for(var c=0;c<a.length;c++){if(a.length>1)s.push("<li>");if(s.push('<div class="info-pic"><a href="'+a[c].doctorLink+'" target="_blank"><img src="'+a[c].avatar+'"></a></div>'),s.push('<div class="infos">'),s.push('<div class="info-title"><div><a href="'+a[c].doctorLink+'" target="_blank">'+a[c].name+"</a></div>"),1==a[c].isVerify)s.push('<a href="'+a[c].verifyLink+'" target="_blank"><i></i></a>');if(s.push("<span>"+a[c].medTitle+"  "+a[c].eduTitle+"</span></div>"),s.push('<p class="info-hospittal">'+a[c].hospitalName+"</p>"),s.push('<p class="info-pos">'+a[c].departName+"</p>"),s.push("</div>"),s.push('<div class="info-time"><p>就诊时间：</p>'+a[c].appointTime+"</div>"),1==t)if(2==r[l].auditStatus&&(1==r[l].source||3==r[l].source)&&0==r[l].isOutDate)s.push('<div class="info-but revise-but">'),s.push('<div class="but-text"></div>'),s.push('<a href="'+r[l].appointmentModifyUrl+'"><p class="comment-but" id="revise-now" data-doctor="'+a[c].id+'" data-order="">立即修改</p></a>'),s.push('<div class="detail-link detail-link-comment">');else if(r[l].canCancel)s.push('<div class="detail-link detail-link-cancel">');else s.push('<div class="detail-link detail-link-only">');else if(2==t)if(6==r[l].auditStatus){if(!r[l].after3day)s.push('<div class="info-but info-have-visit">'),s.push('<div class="but-text"><img src='+n.src+"/common/img/third-days-reward.png></div>");else s.push('<div class="info-but info-have-visit">'),s.push('<div class="but-text"></div>');s.push('<a href="'+r[l].evaluationUrl+'"><p class="comment-but" id="evaluate-now">立即评价</p></a>'),s.push('<div class="detail-link have-visit detail-link-comment">')}else s.push('<div class="detail-link detail-link-only">');if(0==c)if(s.push('<a href="'+r[l].detailUrl+'">查看详情</a>'),'<div class="detail-link detail-link-cancel">'==s[s.length-2])s.push('<br/><span class="cancel-appointment">取消预约</span>');if(s.push("</div>"),a.length>1)s.push("</li>")}if(a.length>1)s.push("</ul>");s.push("</div>"),s.push("</li>")}$("#card").html(s.join("")),$("#revise-now").on("click",function(){window.location.href=""+n.href+"/order.php?doctorId="+$(this).data("doctor")+"&order="+$(this).data("order")})},addDomEvent:function(){var e=this;$("#comment-tab").on("click","span",function(){var t=$(this).data("tag");if(!$(this).hasClass("active")){if("yes"==t)$("#card").empty(),e.evaluationData(1,2);else $("#card").empty(),e.evaluationData(1,1);$(".pagers").empty()}$(this).addClass("active").siblings(".active").removeClass("active")}),$("#card").on("click",".cancel-appointment",function(){var e=$(this).parent().parent().parent(),t=e.find(".appointment-id").html(),i=$("#card li").index(e);$(".popwin-info").show().find(".add_yes").data("value",t).data("index",i)}),$("body").on("click",".card-close, .add_no",function(){$(".popwin-info").hide().find(".add_yes").data("value","").data("index","")}),$("body").on("click",".add_yes",function(){var t=$(this).data("value");if($(".popwin-info").hide(),t){var i=$("#card li").eq($(this).data("index"));i.find(".cancel-appointment").hide();var n=require("common/js/ajax");n({url:""+e.api+"/pc/appointment/cancel",type:"POST",dataType:"json",data:{id:t},success:function(t){if(0==t.status){$("#card").empty();var n=$(".pagination a.currentpage").html();n=n?n:1,e.evaluationData(n,1)}else i.find(".cancel-appointment").show(),alert(t.statusInfo);$(".popwin-info").find(".add_yes").data("value","").data("index","")},error:function(){$(".popwin-info").find(".add_yes").data("value","").data("index",""),i.find(".cancel-appointment").show(),alert("请求出错！")}})}})},init:function(){var e=window.location.hash,t=[],i=e.indexOf("?");if(-1!=i){var n=e.substr(i+1);if(-1!=n.indexOf("&")){strs=n.split("&");for(var a=0;a<strs.length;a++)t[strs[a].split("=")[0]]=strs[a].split("=")[1]}else t[n.split("=")[0]]=n.split("=")[1]}this.zt=t.zt,this.zt_ext=t.zt_ext;var r=$("#comment-tab .total-no").html(),o=$("#comment-tab .total-yes").html();if(r>0)this.evaluationData(1,1);else if(0==r&&0==o)this.evaluationData(1,1);else if(0==r&&o>0)this.evaluationData(1,2),$(".total-yes").parent().addClass("active").siblings(".active").removeClass("active");this.addDomEvent()}}});